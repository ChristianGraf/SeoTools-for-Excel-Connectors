<?xml version="1.0" encoding="utf-8" ?>
<Suite Title="Instagram Scraper" Id="InstagramScraper" Category="Social" SourceUrl="https://github.com/nielsbosma/SeoTools-for-Excel-Connectors/blob/master/InstagramScraper.xml" HelpUrl="" HelpText="Documentation">

  <RestConnector Title="Accounts" Id="Accounts">
    <Parameters>
      <Text Id="RequestAccountString" Title="Account Name or URL" Required="true" Debug.DefaultValue=""/>
    </Parameters>
    <Fetch Url="@(GetAccountRequest())"/>
    <Parse>
      <Regex Title="Followers" Id="Followers" Expr="&quot;followed_by&quot;\s*:\s*\{\s*&quot;count&quot;\s*:\s*(\d+)" Converter="Int"/>
      <Regex Title="Follows" Id="Follows" Expr="&quot;follows&quot;\s*:\s*\{&quot;\s*count&quot;\s*:\s*(\d+)" Converter="Int"/>
      <Regex Title="Posts" Id="Posts" Expr="&quot;media&quot;\s*:\s*\{&quot;\s*count&quot;\s*:\s*(\d+)" Converter="Int"/>	
      <Regex Title="Full name" Id="FullName" Expr="&quot;full_name&quot;:\s*&quot;(.*?)&quot;" Converter="String" Checked="false"/>
      <Regex Title="Homepage" Id="Homepage" Expr="&quot;external_url&quot;:\s*&quot;(.*?)&quot;" Converter="String" Checked="false"/>
      <Regex Title="Avatar URL" Id="AvatarUrl" Expr="&quot;profile_pic_url&quot;:\s*&quot;(.*?)&quot;" Converter="String" Checked="false"/>
      <Regex Title="User Id" Id="UserId" Expr="&quot;owner&quot;:\s*\{&quot;id&quot;:\s*&quot;(.*?)&quot;" Converter="String" Checked="false"/>
    </Parse>
  </RestConnector>

  <RestConnector Title="Media" Id="Media">
    <Parameters>
      <Text Id="RequestPostString" Title="Media URL" Required="true" Debug.DefaultValue=""/>
    </Parameters>
    <Fetch Url="@(GetPostRequest())"/>
    <Parse>
      <JsonPath Title="Media Id" Id="MediaId" Expr="media_id" Converter="String"/>
      <JsonPath Title="Title" Id="Title" Expr="title" Converter="String"/>
      <JsonPath Title="Thumbnail URL" Id="ThumbnailUrl" Expr="thumbnail_url" Converter="String"/>			
      <JsonPath Title="User Id" Id="UserId" Expr="author_id" Converter="String"/>
      <JsonPath Title="User Name" Id="UserName" Expr="author_name" Converter="String"/>
      <JsonPath Title="User URL" Id="UserUrl" Expr="author_url" Converter="String"/>
    </Parse>
  </RestConnector>

  <RazorFunctions>
    <![CDATA[
    String GetAccountRequest()
	  {
		  if(Model.RequestAccountString.Contains("instagram") && Model.RequestAccountString.StartsWith("http"))
		  {
			  return Model.RequestAccountString;
		  }
		  else if(Model.RequestAccountString.Contains("instagram") && !Model.RequestAccountString.StartsWith("http"))
		  {
			  return "https://" + Model.RequestAccountString;
		  }			
		  else if(Model.RequestAccountString.Contains("@"))
		  {
			  return "https://www.instagram.com/" + Model.RequestAccountString.Substring(1);
		  }
			else
			{
			  return "https://www.instagram.com/" + Model.RequestAccountString;
		  }
		}

    String GetPostRequest()
	  {
		  if(Model.RequestPostString.StartsWith("http"))
		  {
			  return "https://api.instagram.com/oembed/?url=" + Model.RequestPostString;
		  }
			else
			{
			  return "https://api.instagram.com/oembed/?url=" + "https://" + Model.RequestPostString;
		  }
    }
    ]]>
  </RazorFunctions>	

</Suite>